<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>교육 명단 관리 (디버깅)</title>
  <style>
    :root{--bg:#0b0d12;--card:#121620;--muted:#94a3b8;--border:#233046;--ink:#e5e7eb;--primary:#1d4ed8;--success:#10b981;--warning:#f59e0b;--error:#ef4444}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui,-apple-system,'Noto Sans KR',sans-serif;padding:20px}
    .container{max-width:800px;margin:0 auto}.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:32px;margin-bottom:24px;box-shadow:0 10px 25px rgba(0,0,0,.2)}
    h1{margin:0 0 8px;color:var(--ink)}.subtitle{color:var(--muted);margin-bottom:32px}
    .form-group{margin-bottom:20px}.form-row{display:grid;gap:16px;grid-template-columns:1fr 1fr}@media(max-width:768px){.form-row{grid-template-columns:1fr}}
    label{display:block;font-weight:600;margin-bottom:8px;color:var(--ink)}
    input[type="text"],input[type="date"],textarea{width:100%;padding:12px 16px;border-radius:10px;border:1px solid var(--border);background:#0f1320;color:var(--ink);font-size:16px;font-family:inherit;transition:border-color .3s}
    textarea{min-height:150px;resize:vertical} input:focus,textarea:focus{outline:none;border-color:var(--primary)}
    .btn{border:1px solid var(--border);background:#101826;color:var(--ink);padding:12px 24px;border-radius:10px;cursor:pointer;font-size:16px;font-weight:500;transition:.3s;text-decoration:none;display:inline-flex;align-items:center;gap:8px;margin-right:12px;margin-bottom:8px}
    .btn:hover{background:#1a2332;border-color:var(--primary)}.btn.primary{border-color:#2563eb;background:var(--primary)}.btn.primary:hover{background:#1e40af}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .status{padding:12px 16px;border-radius:8px;margin:16px 0;font-weight:500;display:none}
    .status.success{background:rgba(16,185,129,.2);color:var(--success);border:1px solid var(--success)}
    .status.error{background:rgba(239,68,68,.2);color:var(--error);border:1px solid var(--error)}
    .status.info{background:rgba(29,78,216,.2);color:var(--primary);border:1px solid var(--primary)}
    .debug-log{background:#1a1a1a;color:#00ff00;padding:10px;border-radius:8px;font-family:monospace;font-size:12px;max-height:200px;overflow-y:auto;margin:10px 0}
    .help-text{font-size:14px;color:var(--muted);margin-top:4px}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>교육 명단 관리 시스템 (디버깅)</h1>
      <p class="subtitle">디버깅용 페이지입니다.</p>

      <!-- 디버그 로그 -->
      <div id="debugLog" class="debug-log">
        === 디버그 로그 ===<br>
        페이지 로딩 완료<br>
      </div>

      <form id="rosterForm">
        <div class="form-group">
          <label for="course">교육명 *</label>
          <input type="text" id="course" placeholder="예: AI 관리자 교육" required>
        </div>

        <div class="form-group">
          <label>교육일정 *</label>
          <div class="form-row">
            <div>
              <input type="date" id="startDate" required>
              <div class="help-text">교육 시작일</div>
            </div>
            <div>
              <input type="date" id="endDate" required>
              <div class="help-text">교육 종료일</div>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="memo">메모 (선택사항)</label>
          <input type="text" id="memo" placeholder="예: 1차수, 오후반">
        </div>

        <div class="form-group">
          <label for="names">참여자 명단 *</label>
          <textarea id="names" placeholder="홍길동,김철수,이영희" required></textarea>
        </div>

        <div style="text-align:center;">
          <button type="submit" class="btn primary" id="saveBtn">명단 등록하기</button>
          <button type="button" class="btn" onclick="testConnection()">연결 테스트</button>
          <button type="button" class="btn" onclick="clearLog()">로그 지우기</button>
        </div>

        <div id="status" class="status"></div>
      </form>
    </div>
  </div>

  <script>
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw5loflVBcAZDyOsA-c2BmgarifK45TXqYDcNkOSkMYeXqkLr3Fw3Q7cAhi74lPFr4TPA/exec';
    
    function addLog(message) {
      const log = document.getElementById('debugLog');
      const time = new Date().toLocaleTimeString();
      log.innerHTML += `[${time}] ${message}<br>`;
      log.scrollTop = log.scrollHeight;
      console.log(`[DEBUG] ${message}`);
    }

    function clearLog() {
      document.getElementById('debugLog').innerHTML = '=== 디버그 로그 ===<br>';
    }

    function showStatus(m, t = 'info') {
      const el = document.getElementById('status');
      el.textContent = m;
      el.className = `status ${t}`;
      el.style.display = 'block';
      addLog(`Status: [${t}] ${m}`);
      if (t === 'success' || t === 'error') {
        setTimeout(() => el.style.display = 'none', 8000);
      }
    }

    function testConnection() {
      addLog('연결 테스트 시작...');
      
      const testUrl = `${APPS_SCRIPT_URL}?action=getRoster&_t=${Date.now()}`;
      addLog(`테스트 URL: ${testUrl}`);
      
      fetch(testUrl, {
        method: 'GET',
        mode: 'cors'
      })
      .then(response => {
        addLog(`HTTP Status: ${response.status}`);
        return response.text();
      })
      .then(data => {
        addLog(`응답 데이터: ${data.substring(0, 200)}...`);
        showStatus('연결 테스트 성공', 'success');
      })
      .catch(error => {
        addLog(`연결 오류: ${error.message}`);
        showStatus('연결 테스트 실패: ' + error.message, 'error');
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      addLog('DOM 로딩 완료');
      
      // 기본값 설정
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('startDate').value = today;
      document.getElementById('endDate').value = today;
      addLog(`기본 날짜 설정: ${today}`);
      
      // Apps Script URL 확인
      addLog(`Apps Script URL: ${APPS_SCRIPT_URL}`);
    });

    document.getElementById('rosterForm').addEventListener('submit', function(e) {
      e.preventDefault();
      addLog('폼 제출 이벤트 발생');
      
      const course = document.getElementById('course').value.trim();
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const memo = document.getElementById('memo').value.trim();
      const namesText = document.getElementById('names').value.trim();
      
      addLog(`입력 데이터 - 교육명: ${course}, 시작일: ${startDate}, 종료일: ${endDate}, 메모: ${memo}`);
      addLog(`참여자 명단: ${namesText.substring(0, 50)}...`);
      
      if (!course || !startDate || !endDate || !namesText) {
        addLog('필수 입력 값 누락');
        showStatus('교육명, 교육일정, 참여자 명단을 모두 입력해주세요.', 'error');
        return;
      }
      
      if (new Date(startDate) > new Date(endDate)) {
        addLog('날짜 검증 실패: 시작일이 종료일보다 늦음');
        showStatus('교육 시작일이 종료일보다 늦을 수 없습니다.', 'error');
        return;
      }
      
      const names = (namesText.includes(',') ? namesText.split(',') : namesText.split('\n'))
        .map(n => n.trim()).filter(Boolean);
      
      if (!names.length) {
        addLog('참여자 명단 파싱 실패');
        showStatus('올바른 참여자 명단을 입력해주세요.', 'error');
        return;
      }
      
      addLog(`처리된 참여자 수: ${names.length}명`);
      addLog(`참여자 목록: ${names.join(', ')}`);
      
      // JSONP 요청
      const cb = 'saveRosterCallback_' + Date.now();
      addLog(`콜백 함수명: ${cb}`);
      
      const params = new URLSearchParams({
        action: 'saveRoster',
        course,
        startDate,
        endDate,
        memo,
        names: names.join(','),
        callback: cb,
        _t: Date.now()
      });
      
      const requestUrl = `${APPS_SCRIPT_URL}?${params.toString()}`;
      addLog(`요청 URL 길이: ${requestUrl.length}`);
      addLog(`요청 URL: ${requestUrl.substring(0, 200)}...`);
      
      const timeout = setTimeout(() => {
        addLog('서버 응답 시간 초과 (30초)');
        cleanup();
        showStatus('서버 응답 시간이 초과되었습니다.', 'error');
      }, 30000);
      
      function cleanup() {
        clearTimeout(timeout);
        delete window[cb];
        const script = document.getElementById('jsonp-script');
        if (script && script.parentNode) {
          document.head.removeChild(script);
          addLog('JSONP 스크립트 제거됨');
        }
      }
      
      window[cb] = function(result) {
        addLog(`서버 응답 받음: ${JSON.stringify(result)}`);
        try {
          if (result && result.ok) {
            addLog('명단 등록 성공');
            showStatus(`명단이 등록되었습니다! (${names.length}명)`, 'success');
            document.getElementById('names').value = '';
          } else {
            throw new Error(result?.error || '명단 등록 실패');
          }
        } catch (err) {
          addLog(`오류 처리: ${err.message}`);
          showStatus('명단 등록 실패: ' + err.message, 'error');
        } finally {
          cleanup();
        }
      };
      
      const script = document.createElement('script');
      script.id = 'jsonp-script';
      script.src = requestUrl;
      script.onerror = function(error) {
        addLog(`스크립트 로딩 오류: ${error}`);
        showStatus('서버 연결 오류', 'error');
        cleanup();
      };
      
      addLog('JSONP 스크립트 추가됨');
      document.head.appendChild(script);
    });
  </script>
</body>
</html>
