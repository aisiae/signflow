<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>êµìœ¡ ì´ìˆ˜ í™•ì¸ Â· ìí•„ ì„œëª…</title>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.2.0/dist/signature_pad.umd.min.js"></script>
  <style>
    :root{--bg:#0b0d12;--card:#121620;--muted:#94a3b8;--border:#233046;--ink:#e5e7eb;--primary:#1d4ed8;--success:#10b981;--error:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui,-apple-system,'Noto Sans KR',sans-serif;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .container{max-width:600px;width:100%}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:32px;box-shadow:0 10px 25px rgba(0,0,0,.3)}
    h1{margin:0 0 8px;color:var(--ink);text-align:center}.subtitle{color:var(--muted);text-align:center;margin-bottom:32px}
    .form-group{margin-bottom:20px}.form-row{display:grid;gap:16px;grid-template-columns:1fr 1fr}@media(max-width:600px){.form-row{grid-template-columns:1fr}}
    label{display:block;font-weight:600;margin-bottom:8px;color:var(--ink)}
    input[type="text"],input[type="tel"],input[type="date"]{width:100%;padding:12px 16px;border-radius:10px;border:1px solid var(--border);background:#0f1320;color:var(--ink);font-size:16px;transition:border-color .3s}
    input:focus{outline:none;border-color:var(--primary)}input:read-only{background:#0a0f19;color:var(--muted)}
    .signature-pad{border:2px solid var(--border);border-radius:12px;width:100%;height:200px;background:#0a0f19;cursor:crosshair;touch-action:none;transition:border-color .3s}
    .signature-pad:hover{border-color:var(--primary)}.signature-controls{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
    .btn{border:1px solid var(--border);background:#101826;color:var(--ink);padding:12px 24px;border-radius:10px;cursor:pointer;font-size:16px;font-weight:500;transition:.3s;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
    .btn:hover{background:#1a2332;border-color:var(--primary)}.btn.primary{border-color:#2563eb;background:var(--primary)}.btn.primary:hover{background:#1e40af}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .checkbox-group{margin:24px 0}.checkbox-wrapper{display:flex;align-items:flex-start;gap:12px}input[type="checkbox"]{margin-top:4px;transform:scale(1.2)}
    .status{margin-top:16px;padding:12px 16px;border-radius:8px;text-align:center;font-weight:500;display:none}
    .status.success{background:rgba(16,185,129,.2);color:var(--success);border:1px solid var(--success)}
    .status.error{background:rgba(239,68,68,.2);color:var(--error);border:1px solid var(--error)}
    .status.info{background:rgba(29,78,216,.2);color:var(--primary);border:1px solid var(--primary)}
    .back-link{position:fixed;top:20px;left:20px;color:var(--muted);text-decoration:none;font-size:14px;padding:8px 12px;border:1px solid var(--border);border-radius:6px;background:var(--card);transition:.3s}
    .back-link:hover{color:var(--ink);border-color:var(--primary)}
    .user-info{background:#0f1320;padding:16px;border-radius:10px;margin-bottom:24px;border-left:4px solid var(--primary)}
    .user-name{font-size:18px;font-weight:600;color:var(--primary);margin-bottom:4px}.course-name{color:var(--muted);font-size:14px}
  </style>
</head>
<body>
  <a href="index.html" class="back-link">â† ëª…ë‹¨ìœ¼ë¡œ</a>

  <div class="container">
    <div class="card">
      <h1>êµìœ¡ ì´ìˆ˜ í™•ì¸ Â· ìí•„ ì„œëª…</h1>
      <p class="subtitle">ì •ë³´ë¥¼ í™•ì¸í•˜ê³  ì„œëª…í•´ì£¼ì„¸ìš”</p>

      <div id="userInfo" class="user-info" style="display:none;">
        <div class="user-name" id="displayName"></div>
        <div class="course-name" id="displayCourse"></div>
      </div>

      <form id="signatureForm">
        <div class="form-row">
          <div class="form-group">
            <label for="name">ì´ë¦„ *</label>
            <input type="text" id="name" name="name" readonly>
          </div>
          <div class="form-group">
            <label for="phone">íœ´ëŒ€í° ë²ˆí˜¸ *</label>
            <input type="tel" id="phone" name="phone" placeholder="010-1234-5678" required>
            <div class="help-text" style="color:#94a3b8;font-size:14px">ìˆ«ìë§Œ ì…ë ¥í•˜ê±°ë‚˜ 010-1234-5678 í˜•ì‹</div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="course">êµìœ¡ëª… *</label>
            <input type="text" id="course" name="course" readonly>
          </div>
          <div class="form-group">
            <label for="date">ì„œëª…ì¼ì *</label>
            <input type="date" id="date" name="date" required>
            <div class="help-text" style="color:#94a3b8;font-size:14px">ì„œëª…í•˜ëŠ” ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</div>
          </div>
        </div>

        <div class="form-group">
          <label>ìí•„ ì„œëª… *</label>
          <canvas id="signaturePad" class="signature-pad"></canvas>
          <div class="signature-controls">
            <button type="button" id="clearBtn" class="btn">ì§€ìš°ê¸°</button>
            <span class="help-text" style="color:#94a3b8">ë§ˆìš°ìŠ¤ë‚˜ í„°ì¹˜ë¡œ ì„œëª…í•´ì£¼ì„¸ìš”</span>
          </div>
        </div>

        <div class="checkbox-group">
          <div class="checkbox-wrapper">
            <input type="checkbox" id="agree" required>
            <label for="agree">ì…ë ¥í•œ ì •ë³´ ë° ì„œëª… ì´ë¯¸ì§€ë¥¼ êµìœ¡ ì´ìˆ˜ í™•ì¸ ëª©ì ìœ¼ë¡œ ìˆ˜ì§‘Â·ë³´ê´€í•˜ëŠ” ê²ƒì— ë™ì˜í•©ë‹ˆë‹¤.</label>
          </div>
        </div>

        <button type="submit" class="btn primary" id="submitBtn">ì œì¶œí•˜ê¸°</button>
        <div id="status" class="status"></div>
      </form>
    </div>
  </div>

  <script>
    // ğŸ‘‡ ìƒˆë¡œ ë°°í¬í•œ Apps Script WebApp URL
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby5aTrdZ1tUmSZSFkoSeQyDYhEXzngopgIDyPv_4h-dyxQoqqH6uyeUFTBJq7AXxR0G-w/exec';
    let signaturePad=null;

    function getUrlParams(){
      const p=new URLSearchParams(window.location.search);
      return {name:p.get('name')||'',course:p.get('course')||'',startDate:p.get('startDate')||'',endDate:p.get('endDate')||'',memo:p.get('memo')||'',phone:p.get('phone')||''};
    }
    function fillFormFromParams(){
      const params=getUrlParams();
      if(params.name){
        document.getElementById('name').value=params.name;
        document.getElementById('displayName').textContent=params.name+' ë‹˜';
        document.getElementById('userInfo').style.display='block';
      }
      if(params.course){
        document.getElementById('course').value=params.course;
        document.getElementById('displayCourse').textContent=params.course;
      }
      if(params.phone){
        document.getElementById('phone').value=params.phone;
      }
      // ì„œëª…ì¼ìëŠ” ì˜¤ëŠ˜ ë‚ ì§œë¡œ ê¸°ë³¸ ì„¤ì •, êµìœ¡ ê¸°ê°„ ë²”ìœ„ ë‚´ì—ì„œë§Œ ì„ íƒ ê°€ëŠ¥
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('date').value=today;
      
      // êµìœ¡ ê¸°ê°„ì´ ìˆìœ¼ë©´ ë‚ ì§œ ì…ë ¥ ë²”ìœ„ ì œí•œ
      if(params.startDate && params.endDate){
        document.getElementById('date').min = params.startDate;
        document.getElementById('date').max = params.endDate;
      }
    }
    function initSignaturePad(){
      const canvas=document.getElementById('signaturePad');
      function resize(){const r=Math.max(window.devicePixelRatio||1,1);const rect=canvas.getBoundingClientRect();canvas.width=rect.width*r;canvas.height=rect.height*r;canvas.getContext('2d').scale(r,r);canvas.style.width=rect.width+'px';canvas.style.height=rect.height+'px';}
      resize(); window.addEventListener('resize',resize);
      signaturePad=new SignaturePad(canvas,{backgroundColor:'rgba(255,255,255,0)',penColor:'#ffffff',minWidth:1,maxWidth:3,throttle:16});
    }
    function showStatus(m,t='info'){const el=document.getElementById('status');el.textContent=m;el.className=`status ${t}`;el.style.display='block';if(t!=='info')setTimeout(()=>el.style.display='none',10000);}
    function validatePhone(p){const c=p.replace(/\D/g,'');return c.length>=10&&c.length<=11;}

    function handleSubmit(e){
      e.preventDefault();
      if(!signaturePad||signaturePad.isEmpty()){alert('ì„œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');return;}
      const phoneInput=document.getElementById('phone');
      if(!validatePhone(phoneInput.value)){alert('íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.');phoneInput.focus();return;}
      const name=document.getElementById('name').value.trim();
      const course=document.getElementById('course').value.trim();
      const date=document.getElementById('date').value;
      const phone=phoneInput.value.replace(/\D/g,'');
      if(!name||!course||!date){alert('ëª¨ë“  í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');return;}
      if(!document.getElementById('agree').checked){alert('ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš©ì— ë™ì˜í•´ì£¼ì„¸ìš”.');return;}

      const submitBtn=document.getElementById('submitBtn'); submitBtn.disabled=true; submitBtn.textContent='ì œì¶œ ì¤‘...';
      showStatus('ì„œëª…ì„ ì œì¶œí•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...','info');

      const formData={name,phone,course,startDate:getUrlParams().startDate||'',endDate:getUrlParams().endDate||'',memo:getUrlParams().memo||'',signature:signaturePad.toDataURL('image/jpeg',0.15),submittedAt:new Date().toISOString()};
      submitViaJsonp(formData).then(ok=>{
        if(ok){
          showStatus('ì„œëª…ì´ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤! 5ì´ˆ í›„ ë©”ì¸ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.','success');
          document.getElementById('signatureForm').style.pointerEvents='none';
          document.getElementById('signatureForm').style.opacity='.7';
          setTimeout(()=>location.href='index.html',5000);
        }else{throw new Error('ì œì¶œ ì‹¤íŒ¨');}
      }).catch(err=>{
        console.error(err);showStatus('ì„œëª… ì œì¶œ ì‹¤íŒ¨: '+err.message,'error');
      }).finally(()=>{submitBtn.disabled=false;submitBtn.textContent='ì œì¶œí•˜ê¸°';});
    }

    function submitViaJsonp(formData){
      return new Promise((resolve,reject)=>{
        if(formData.signature.length>8000){reject(new Error('ì„œëª… ë°ì´í„°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. ë” ê°„ë‹¨íˆ ì„œëª…í•´ì£¼ì„¸ìš”.'));return;}
        const cb='submitCallback_'+Date.now();
        const to=setTimeout(()=>{cleanup();reject(new Error('ì„œë²„ ì‘ë‹µ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.'));},60000);
        function cleanup(){clearTimeout(to);delete window[cb];const s=document.getElementById('jsonp-submit');if(s&&s.parentNode)document.head.removeChild(s);}
        window[cb]=function(result){cleanup(); if(result&&result.ok){resolve(true);} else {reject(new Error(result?.error||'ì„œë²„ ì˜¤ë¥˜'));}};
        const params=new URLSearchParams({action:'submitSignature',name:formData.name,phone:formData.phone,course:formData.course,startDate:formData.startDate,endDate:formData.endDate,memo:formData.memo,signature:formData.signature,submittedAt:formData.submittedAt,callback:cb,_t:Date.now()});
        const script=document.createElement('script'); script.id='jsonp-submit'; script.src=`${APPS_SCRIPT_URL}?${params.toString()}`;
        script.onerror=function(){cleanup();reject(new Error('ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì˜¤ë¥˜'));};
        document.head.appendChild(script);
      });
    }

    document.addEventListener('DOMContentLoaded',()=>{
      fillFormFromParams();
      setTimeout(initSignaturePad,100);
      document.getElementById('clearBtn').addEventListener('click',()=>signaturePad&&signaturePad.clear());
      document.getElementById('signatureForm').addEventListener('submit',handleSubmit);
      window.addEventListener('beforeunload',e=>{if(signaturePad&&!signaturePad.isEmpty()){e.preventDefault();e.returnValue='';}});
    });
  </script>
</body>
</html>

