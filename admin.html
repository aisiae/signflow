<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>êµìœ¡ ëª…ë‹¨ ê´€ë¦¬</title>
<style>
  :root{--bg:#0b0d12;--card:#121620;--muted:#94a3b8;--border:#233046;--ink:#e5e7eb;--primary:#1d4ed8;--success:#10b981;--warning:#f59e0b;--error:#ef4444}
  *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui,-apple-system,'Noto Sans KR',sans-serif;padding:20px}
  .container{max-width:900px;margin:0 auto}.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:32px;margin-bottom:24px;box-shadow:0 10px 25px rgba(0,0,0,.2)}
  h1{margin:0 0 8px}.subtitle{color:var(--muted);margin-bottom:32px}
  .form-group{margin-bottom:20px}.form-row{display:grid;gap:16px;grid-template-columns:1fr 1fr}@media(max-width:768px){.form-row{grid-template-columns:1fr}}
  label{display:block;font-weight:600;margin-bottom:8px}
  input[type="text"],input[type="date"],textarea{width:100%;padding:12px 16px;border-radius:10px;border:1px solid var(--border);background:#0f1320;color:var(--ink);font-size:16px}
  textarea{min-height:150px;resize:vertical}
  .btn{border:1px solid var(--border);background:#101826;color:var(--ink);padding:12px 24px;border-radius:10px;cursor:pointer;font-size:16px;font-weight:500;transition:.3s;text-decoration:none;display:inline-flex;align-items:center;gap:8px;margin-right:12px;margin-bottom:8px}
  .btn:hover{background:#1a2332;border-color:var(--primary)}.btn.primary{border-color:#2563eb;background:var(--primary)}.btn.primary:hover{background:#1e40af}.btn.warning{border-color:var(--warning);background:var(--warning);color:#000}.btn:disabled{opacity:.6;cursor:not-allowed}
  .status{padding:12px 16px;border-radius:8px;margin:16px 0;font-weight:500;display:none}
  .status.success{background:rgba(16,185,129,.2);color:#10b981;border:1px solid #10b981}
  .status.error{background:rgba(239,68,68,.2);color:#ef4444;border:1px solid #ef4444}
  .status.info{background:rgba(29,78,216,.2);color:#1d4ed8;border:1px solid #1d4ed8}
  .url-box{background:#0f1320;border:2px solid var(--primary);border-radius:12px;padding:20px;margin-top:20px;text-align:center}
  .main-url{font-family:'Courier New',monospace;font-size:18px;font-weight:bold;color:var(--primary);word-break:break-all;margin-bottom:12px}
  table{width:100%;border-collapse:collapse}th,td{padding:8px;border-bottom:1px solid var(--border)}
</style>
</head>
<body>
<a href="index.html" class="btn" style="position:fixed;top:16px;left:16px;">â† ë©”ì¸</a>
<div class="container"><div class="card">
  <h1>êµìœ¡ ëª…ë‹¨ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
  <p class="subtitle">ëª…ë‹¨ ë“±ë¡ â†’ ì£¼ì†Œ ê³µìœ  â†’ ì°¸ì—¬ì ì„œëª… ìˆ˜ì§‘ â†’ PDF ìƒì„±ê¹Œì§€</p>

  <!-- ëª…ë‹¨ ë“±ë¡ -->
  <form id="rosterForm">
    <div class="form-row">
      <div class="form-group">
        <label for="course">êµìœ¡ëª… *</label>
        <input type="text" id="course" placeholder="ì˜ˆ: AI ê´€ë¦¬ì êµìœ¡" required>
      </div>
      <div class="form-group">
        <label for="date">êµìœ¡ì¼ì • *</label>
        <input type="date" id="date" required>
      </div>
    </div>
    <div class="form-group">
      <label for="memo">ë©”ëª¨ (ì„ íƒ)</label>
      <input type="text" id="memo" placeholder="ì˜ˆ: 1ì°¨ìˆ˜, ì˜¤í›„ë°˜">
    </div>
    <div class="form-group">
      <label for="names">ì°¸ì—¬ì ëª…ë‹¨ *</label>
      <textarea id="names" placeholder="í™ê¸¸ë™,ê¹€ì² ìˆ˜,ì´ì˜í¬ ë˜ëŠ” ì¤„ë°”ê¿ˆìœ¼ë¡œ í•œ ì¤„ì— í•œ ëª…" required></textarea>
    </div>
    <div style="text-align:center;">
      <button type="submit" class="btn primary" id="saveBtn"><span id="saveText">ëª…ë‹¨ ë“±ë¡í•˜ê¸°</span><span id="saveSpinner" style="display:none;">â³</span></button>
      <button type="button" class="btn" id="clearBtn">ì´ˆê¸°í™”</button>
    </div>
    <div id="status" class="status"></div>
  </form>

  <!-- ë©”ì¸ ì£¼ì†Œ -->
  <div class="url-box">
    <div class="main-url" id="mainUrl"></div>
    <button class="btn primary" onclick="copyMainUrl()">ë©”ì¸ ì£¼ì†Œ ë³µì‚¬</button>
  </div>

  <!-- ì„œëª… í™•ì¸ & PDF -->
  <div style="margin-top:24px;">
    <h3>ğŸ–Šï¸ ì œì¶œëœ ì„œëª… í™•ì¸ / PDF ìƒì„±</h3>
    <div class="form-row">
      <div class="form-group">
        <label for="sigCourse">êµìœ¡ëª…(ì„ íƒ)</label>
        <input type="text" id="sigCourse" placeholder="ì˜ˆ: AI ê´€ë¦¬ì êµìœ¡">
      </div>
      <div class="form-group">
        <label for="sigDate">ì´ìˆ˜ì¼ì(ì„ íƒ)</label>
        <input type="date" id="sigDate">
      </div>
    </div>
    <div style="text-align:right;margin-bottom:12px;">
      <button class="btn" id="loadSignaturesBtn">ìµœì‹  ì„œëª… ë³´ê¸°</button>
      <button class="btn warning" id="pdfBtn">PDF ìƒì„±(í•œ ë¬¸ì„œë¡œ ì·¨í•©)</button>
    </div>
    <div id="sigStatus" class="status" style="display:none;"></div>
    <div style="overflow:auto;">
      <table id="sigTable">
        <thead><tr style="color:#94a3b8;"><th>ì œì¶œì‹œê°„</th><th>ì´ë¦„</th><th>íœ´ëŒ€í°</th><th>êµìœ¡ëª…</th><th>ì´ìˆ˜ì¼ì</th><th>ë©”ëª¨</th><th>ì´ë¯¸ì§€</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div></div>

<script>
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxqFUwh7rcpRN0VzFBeGaoLtpq1_g3nsAElA8kOj-fivyp7xZ2m6v7vl7z7xt7TDciF/exec';

// ì´ˆê¸° ì„¸íŒ…
document.addEventListener('DOMContentLoaded', ()=>{
  const today=new Date().toISOString().split('T')[0];
  if(!document.getElementById('date').value) document.getElementById('date').value=today;
  const base=location.origin+location.pathname.replace('admin.html','index.html');
  document.getElementById('mainUrl').textContent=base;
});

function showStatus(m,t='info'){const el=status;el.textContent=m;el.className=`status ${t}`;el.style.display='block';if(t!=='info')setTimeout(()=>el.style.display='none',8000);}
function setLoading(b){saveBtn.disabled=b;saveText.style.display=b?'none':'inline';saveSpinner.style.display=b?'inline':'none';}
function copyMainUrl(){const url=mainUrl.textContent;navigator.clipboard?.writeText(url).then(()=>showStatus('ë©”ì¸ ì£¼ì†Œ ë³µì‚¬ ì™„ë£Œ','success'));}

rosterForm.addEventListener('submit', e=>{
  e.preventDefault();
  const course=course.value.trim(), dateA=date.value, memoA=memo.value.trim();
  const namesText=names.value.trim();
  if(!course||!dateA||!namesText){showStatus('êµìœ¡ëª…/ì¼ì •/ëª…ë‹¨ì„ ëª¨ë‘ ì…ë ¥','error');return;}
  const parsed=(namesText.includes(',')?namesText.split(','):namesText.split('\n')).map(s=>s.trim()).filter(Boolean);
  if(!parsed.length){showStatus('ì°¸ì—¬ì ëª…ë‹¨ í˜•ì‹ì„ í™•ì¸','error');return;}
  setLoading(true); showStatus('ëª…ë‹¨ ë“±ë¡ ì¤‘...','info');

  const cb='saveRosterCb_'+Date.now(); const to=setTimeout(()=>{cleanup();showStatus('ì‘ë‹µ ì‹œê°„ ì´ˆê³¼','error');},30000);
  function cleanup(){clearTimeout(to);delete window[cb];const s=document.getElementById('save-jsonp');if(s&&s.parentNode)document.head.removeChild(s);setLoading(false);}
  window[cb]=res=>{try{if(res&&res.ok){showStatus(`ë“±ë¡ ì™„ë£Œ (${parsed.length}ëª…)`,`success`);names.value='';}else{throw new Error(res?.error||'ë“±ë¡ ì‹¤íŒ¨');}}catch(err){showStatus('ì˜¤ë¥˜: '+err.message,'error');}finally{cleanup();}};
  const q=new URLSearchParams({action:'saveRoster',course:course,date:dateA,memo:memoA,names:parsed.join(','),callback:cb,_t:Date.now()});
  const s=document.createElement('script');s.id='save-jsonp';s.src=`${APPS_SCRIPT_URL}?${q.toString()}`;s.onerror=()=>{cleanup();showStatus('ì„œë²„ ì—°ê²° ì˜¤ë¥˜','error');};document.head.appendChild(s);
});
clearBtn.addEventListener('click', ()=>{course.value='';date.value=new Date().toISOString().split('T')[0];memo.value='';names.value='';status.style.display='none';});

// ì„œëª… ëª©ë¡ ë³´ê¸°
document.getElementById('loadSignaturesBtn').addEventListener('click', loadSignatures);
function loadSignatures(){
  const tbody=document.querySelector('#sigTable tbody'); const st=sigStatus;
  const courseV=sigCourse.value.trim(); const dateV=sigDate.value;
  const cb='sigCb_'+Date.now(); st.textContent='ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';st.className='status info';st.style.display='block';
  const to=setTimeout(()=>{cleanup();st.textContent='ì‘ë‹µ ì‹œê°„ ì´ˆê³¼';st.className='status error';},30000);
  function cleanup(){clearTimeout(to);delete window[cb];const s=document.getElementById('jsonp-sigs');if(s&&s.parentNode)document.head.removeChild(s);}
  window[cb]=res=>{cleanup(); try{
    if(!res||!res.ok) throw new Error(res?.error||'ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨');
    tbody.innerHTML=''; (res.items||[]).forEach(it=>{
      const tr=document.createElement('tr');
      const td=t=>{const e=document.createElement('td');e.textContent=t||'';return e;};
      tr.appendChild(td(it.time?new Date(it.time).toLocaleString():'')); tr.appendChild(td(it.name)); tr.appendChild(td(it.phone)); tr.appendChild(td(it.course)); tr.appendChild(td(it.date)); tr.appendChild(td(it.memo));
      const link=document.createElement('td');
      if(it.url){const a=document.createElement('a');a.href=it.url;a.target='_blank';a.textContent='ì—´ê¸°';a.className='btn';a.style.padding='6px 10px';link.appendChild(a);} else {link.textContent='-';}
      tr.appendChild(link); tbody.appendChild(tr);
    });
    st.textContent = `ì´ ${res.total}ê±´ ì¤‘ ${ (res.items||[]).length }ê±´ í‘œì‹œ`; st.className='status success';
  }catch(e){st.textContent='ì˜¤ë¥˜: '+e.message;st.className='status error';}};
  const q=new URLSearchParams({action:'getSignatures',limit:'200',callback:cb,_t:Date.now()});
  if(courseV) q.set('course',courseV); if(dateV) q.set('date',dateV);
  const s=document.createElement('script');s.id='jsonp-sigs';s.src=`${APPS_SCRIPT_URL}?${q.toString()}`;s.onerror=()=>{cleanup();st.textContent='ì„œë²„ ì—°ê²° ì˜¤ë¥˜';st.className='status error';};document.head.appendChild(s);
}

// PDF ìƒì„±
document.getElementById('pdfBtn').addEventListener('click', ()=>{
  const courseV=sigCourse.value.trim(); const dateV=sigDate.value;
  const q=new URLSearchParams({action:'pdf',_t:Date.now()}); if(courseV) q.set('course',courseV); if(dateV) q.set('date',dateV);
  const url=`${APPS_SCRIPT_URL}?${q.toString()}`;
  const w = window.open(url,'_blank');
  if(!w){sigStatus.textContent='íŒì—… ì°¨ë‹¨ì„ í•´ì œí•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';sigStatus.className='status error';sigStatus.style.display='block';}
});
</script>
</body>
</html>
