<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>교육 명단 관리</title>
<style>
  :root{--bg:#0b0d12;--card:#121620;--muted:#94a3b8;--border:#233046;--ink:#e5e7eb;--primary:#1d4ed8;--success:#10b981;--warning:#f59e0b;--error:#ef4444}
  *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui,-apple-system,'Noto Sans KR',sans-serif;padding:20px}
  .container{max-width:900px;margin:0 auto}.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:32px;margin-bottom:24px;box-shadow:0 10px 25px rgba(0,0,0,.2)}
  h1{margin:0 0 8px}.subtitle{color:var(--muted);margin-bottom:32px}
  .form-group{margin-bottom:20px}.form-row{display:grid;gap:16px;grid-template-columns:1fr 1fr}@media(max-width:768px){.form-row{grid-template-columns:1fr}}
  label{display:block;font-weight:600;margin-bottom:8px}
  input[type="text"],input[type="date"],textarea{width:100%;padding:12px 16px;border-radius:10px;border:1px solid var(--border);background:#0f1320;color:var(--ink);font-size:16px}
  textarea{min-height:150px;resize:vertical}
  .btn{border:1px solid var(--border);background:#101826;color:var(--ink);padding:12px 24px;border-radius:10px;cursor:pointer;font-size:16px;font-weight:500;transition:.3s;text-decoration:none;display:inline-flex;align-items:center;gap:8px;margin-right:12px;margin-bottom:8px}
  .btn:hover{background:#1a2332;border-color:var(--primary)}.btn.primary{border-color:#2563eb;background:var(--primary)}.btn.primary:hover{background:#1e40af}.btn.warning{border-color:var(--warning);background:var(--warning);color:#000}.btn:disabled{opacity:.6;cursor:not-allowed}
  .status{padding:12px 16px;border-radius:8px;margin:16px 0;font-weight:500;display:none}
  .status.success{background:rgba(16,185,129,.2);color:#10b981;border:1px solid #10b981}
  .status.error{background:rgba(239,68,68,.2);color:#ef4444;border:1px solid #ef4444}
  .status.info{background:rgba(29,78,216,.2);color:#1d4ed8;border:1px solid #1d4ed8}
  .url-box{background:#0f1320;border:2px solid var(--primary);border-radius:12px;padding:20px;margin-top:20px;text-align:center}
  .main-url{font-family:'Courier New',monospace;font-size:18px;font-weight:bold;color:var(--primary);word-break:break-all;margin-bottom:12px}
  table{width:100%;border-collapse:collapse}th,td{padding:8px;border-bottom:1px solid var(--border)}
</style>
</head>
<body>
<a href="index.html" class="btn" style="position:fixed;top:16px;left:16px;">← 메인</a>
<div class="container"><div class="card">
  <h1>교육 명단 관리 시스템</h1>
  <p class="subtitle">명단 등록 → 주소 공유 → 참여자 서명 수집 → PDF 생성까지</p>

  <!-- 명단 등록 -->
  <form id="rosterForm">
    <div class="form-row">
      <div class="form-group">
        <label for="course">교육명 *</label>
        <input type="text" id="course" placeholder="예: AI 관리자 교육" required>
      </div>
      <div class="form-group">
        <label for="date">교육일정 *</label>
        <input type="date" id="date" required>
      </div>
    </div>
    <div class="form-group">
      <label for="memo">메모 (선택)</label>
      <input type="text" id="memo" placeholder="예: 1차수, 오후반">
    </div>
    <div class="form-group">
      <label for="names">참여자 명단 *</label>
      <textarea id="names" placeholder="홍길동,김철수,이영희 또는 줄바꿈으로 한 줄에 한 명" required></textarea>
    </div>
    <div style="text-align:center;">
      <button type="submit" class="btn primary" id="saveBtn"><span id="saveText">명단 등록하기</span><span id="saveSpinner" style="display:none;">⏳</span></button>
      <button type="button" class="btn" id="clearBtn">초기화</button>
    </div>
    <div id="status" class="status"></div>
  </form>

  <!-- 메인 주소 -->
  <div class="url-box">
    <div class="main-url" id="mainUrl"></div>
    <button class="btn primary" onclick="copyMainUrl()">메인 주소 복사</button>
  </div>

  <!-- 서명 확인 & PDF -->
  <div style="margin-top:24px;">
    <h3>🖊️ 제출된 서명 확인 / PDF 생성</h3>
    <div class="form-row">
      <div class="form-group">
        <label for="sigCourse">교육명(선택)</label>
        <input type="text" id="sigCourse" placeholder="예: AI 관리자 교육">
      </div>
      <div class="form-group">
        <label for="sigDate">이수일자(선택)</label>
        <input type="date" id="sigDate">
      </div>
    </div>
    <div style="text-align:right;margin-bottom:12px;">
      <button class="btn" id="loadSignaturesBtn">최신 서명 보기</button>
      <button class="btn warning" id="pdfBtn">PDF 생성(한 문서로 취합)</button>
    </div>
    <div id="sigStatus" class="status" style="display:none;"></div>
    <div style="overflow:auto;">
      <table id="sigTable">
        <thead><tr style="color:#94a3b8;"><th>제출시간</th><th>이름</th><th>휴대폰</th><th>교육명</th><th>이수일자</th><th>메모</th><th>이미지</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div></div>

<script>
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxqFUwh7rcpRN0VzFBeGaoLtpq1_g3nsAElA8kOj-fivyp7xZ2m6v7vl7z7xt7TDciF/exec';

// 초기 세팅
document.addEventListener('DOMContentLoaded', ()=>{
  const today=new Date().toISOString().split('T')[0];
  if(!document.getElementById('date').value) document.getElementById('date').value=today;
  const base=location.origin+location.pathname.replace('admin.html','index.html');
  document.getElementById('mainUrl').textContent=base;
});

function showStatus(m,t='info'){const el=status;el.textContent=m;el.className=`status ${t}`;el.style.display='block';if(t!=='info')setTimeout(()=>el.style.display='none',8000);}
function setLoading(b){saveBtn.disabled=b;saveText.style.display=b?'none':'inline';saveSpinner.style.display=b?'inline':'none';}
function copyMainUrl(){const url=mainUrl.textContent;navigator.clipboard?.writeText(url).then(()=>showStatus('메인 주소 복사 완료','success'));}

rosterForm.addEventListener('submit', e=>{
  e.preventDefault();
  const course=course.value.trim(), dateA=date.value, memoA=memo.value.trim();
  const namesText=names.value.trim();
  if(!course||!dateA||!namesText){showStatus('교육명/일정/명단을 모두 입력','error');return;}
  const parsed=(namesText.includes(',')?namesText.split(','):namesText.split('\n')).map(s=>s.trim()).filter(Boolean);
  if(!parsed.length){showStatus('참여자 명단 형식을 확인','error');return;}
  setLoading(true); showStatus('명단 등록 중...','info');

  const cb='saveRosterCb_'+Date.now(); const to=setTimeout(()=>{cleanup();showStatus('응답 시간 초과','error');},30000);
  function cleanup(){clearTimeout(to);delete window[cb];const s=document.getElementById('save-jsonp');if(s&&s.parentNode)document.head.removeChild(s);setLoading(false);}
  window[cb]=res=>{try{if(res&&res.ok){showStatus(`등록 완료 (${parsed.length}명)`,`success`);names.value='';}else{throw new Error(res?.error||'등록 실패');}}catch(err){showStatus('오류: '+err.message,'error');}finally{cleanup();}};
  const q=new URLSearchParams({action:'saveRoster',course:course,date:dateA,memo:memoA,names:parsed.join(','),callback:cb,_t:Date.now()});
  const s=document.createElement('script');s.id='save-jsonp';s.src=`${APPS_SCRIPT_URL}?${q.toString()}`;s.onerror=()=>{cleanup();showStatus('서버 연결 오류','error');};document.head.appendChild(s);
});
clearBtn.addEventListener('click', ()=>{course.value='';date.value=new Date().toISOString().split('T')[0];memo.value='';names.value='';status.style.display='none';});

// 서명 목록 보기
document.getElementById('loadSignaturesBtn').addEventListener('click', loadSignatures);
function loadSignatures(){
  const tbody=document.querySelector('#sigTable tbody'); const st=sigStatus;
  const courseV=sigCourse.value.trim(); const dateV=sigDate.value;
  const cb='sigCb_'+Date.now(); st.textContent='불러오는 중...';st.className='status info';st.style.display='block';
  const to=setTimeout(()=>{cleanup();st.textContent='응답 시간 초과';st.className='status error';},30000);
  function cleanup(){clearTimeout(to);delete window[cb];const s=document.getElementById('jsonp-sigs');if(s&&s.parentNode)document.head.removeChild(s);}
  window[cb]=res=>{cleanup(); try{
    if(!res||!res.ok) throw new Error(res?.error||'가져오기 실패');
    tbody.innerHTML=''; (res.items||[]).forEach(it=>{
      const tr=document.createElement('tr');
      const td=t=>{const e=document.createElement('td');e.textContent=t||'';return e;};
      tr.appendChild(td(it.time?new Date(it.time).toLocaleString():'')); tr.appendChild(td(it.name)); tr.appendChild(td(it.phone)); tr.appendChild(td(it.course)); tr.appendChild(td(it.date)); tr.appendChild(td(it.memo));
      const link=document.createElement('td');
      if(it.url){const a=document.createElement('a');a.href=it.url;a.target='_blank';a.textContent='열기';a.className='btn';a.style.padding='6px 10px';link.appendChild(a);} else {link.textContent='-';}
      tr.appendChild(link); tbody.appendChild(tr);
    });
    st.textContent = `총 ${res.total}건 중 ${ (res.items||[]).length }건 표시`; st.className='status success';
  }catch(e){st.textContent='오류: '+e.message;st.className='status error';}};
  const q=new URLSearchParams({action:'getSignatures',limit:'200',callback:cb,_t:Date.now()});
  if(courseV) q.set('course',courseV); if(dateV) q.set('date',dateV);
  const s=document.createElement('script');s.id='jsonp-sigs';s.src=`${APPS_SCRIPT_URL}?${q.toString()}`;s.onerror=()=>{cleanup();st.textContent='서버 연결 오류';st.className='status error';};document.head.appendChild(s);
}

// PDF 생성
document.getElementById('pdfBtn').addEventListener('click', ()=>{
  const courseV=sigCourse.value.trim(); const dateV=sigDate.value;
  const q=new URLSearchParams({action:'pdf',_t:Date.now()}); if(courseV) q.set('course',courseV); if(dateV) q.set('date',dateV);
  const url=`${APPS_SCRIPT_URL}?${q.toString()}`;
  const w = window.open(url,'_blank');
  if(!w){sigStatus.textContent='팝업 차단을 해제하고 다시 시도해주세요.';sigStatus.className='status error';sigStatus.style.display='block';}
});
</script>
</body>
</html>
